{"version":3,"sources":["test/Executable.test.ts"],"names":[],"mappings":"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","file":"Executable.test.js","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\nimport * as os from 'os';\r\nimport * as path from 'path';\r\nimport * as child_process from 'child_process';\r\n\r\nimport { Executable, IExecutableSpawnSyncOptions } from '../Executable';\r\nimport { FileSystem, PosixModeBits } from '../FileSystem';\r\nimport { Text } from '../Text';\r\n\r\n// The PosixModeBits are intended to be used with bitwise operations.\r\n// tslint:disable:no-bitwise\r\n\r\n// Use src/test/test-data instead of lib/test/test-data\r\nconst executableFolder: string = path.join(__dirname, '..', '..', 'src', 'test', 'test-data', 'executable');\r\n\r\nlet environment: NodeJS.ProcessEnv;\r\n\r\nif (os.platform() === 'win32') {\r\n  environment = {\r\n    PATH: [\r\n      path.join(executableFolder, 'skipped'),\r\n      path.join(executableFolder, 'success'),\r\n      path.join(executableFolder, 'fail'),\r\n      path.dirname(process.execPath) // the folder where node.exe can be found\r\n    ].join(path.delimiter),\r\n\r\n    PATHEXT: '.COM;.EXE;.BAT;.CMD;.VBS',\r\n\r\n    TEST_VAR: '123'\r\n  };\r\n} else {\r\n  environment = {\r\n    PATH: [\r\n      path.join(executableFolder, 'skipped'),\r\n      path.join(executableFolder, 'success'),\r\n      path.join(executableFolder, 'fail'),\r\n      path.dirname(process.execPath), // the folder where node.exe can be found\r\n      // These are needed because our example script needs to find bash\r\n      '/usr/local/bin',\r\n      '/usr/bin',\r\n      '/bin'\r\n    ].join(path.delimiter),\r\n\r\n    TEST_VAR: '123'\r\n  };\r\n}\r\n\r\nconst options: IExecutableSpawnSyncOptions = {\r\n  environment: environment,\r\n  currentWorkingDirectory: executableFolder,\r\n  stdio: 'pipe'\r\n};\r\n\r\nbeforeAll(() => {\r\n  // Make sure the test folder exists where we expect it\r\n  expect(FileSystem.exists(executableFolder)).toEqual(true);\r\n\r\n  // Git's core.filemode setting wrongly defaults to true on Windows.  This design flaw makes\r\n  // it completely impractical to store POSIX file permissions in a cross-platform Git repo.\r\n  // So instead we set them before the test runs, and then revert them after the test completes.\r\n  if (os.platform() !== 'win32') {\r\n    FileSystem.changePosixModeBits(path.join(executableFolder, 'success', 'npm-binary-wrapper'),\r\n      PosixModeBits.AllRead | PosixModeBits.AllWrite | PosixModeBits.AllExecute);\r\n    FileSystem.changePosixModeBits(path.join(executableFolder, 'success', 'bash-script.sh'),\r\n      PosixModeBits.AllRead | PosixModeBits.AllWrite | PosixModeBits.AllExecute);\r\n  }\r\n});\r\n\r\nafterAll(() => {\r\n  // Revert the permissions to the defaults\r\n  if (os.platform() !== 'win32') {\r\n    FileSystem.changePosixModeBits(path.join(executableFolder, 'success', 'npm-binary-wrapper'),\r\n      PosixModeBits.AllRead | PosixModeBits.AllWrite);\r\n    FileSystem.changePosixModeBits(path.join(executableFolder, 'success', 'bash-script.sh'),\r\n      PosixModeBits.AllRead | PosixModeBits.AllWrite);\r\n  }\r\n});\r\n\r\ntest('Executable.tryResolve() pathless', () => {\r\n  const resolved: string | undefined = Executable.tryResolve('npm-binary-wrapper', options);\r\n  expect(resolved).toBeDefined();\r\n  const resolvedRelative: string = Text.replaceAll(path.relative(executableFolder, resolved!),\r\n    '\\\\', '/');\r\n\r\n  if (os.platform() === 'win32') {\r\n    // On Windows, we should find npm-binary-wrapper.cmd instead of npm-binary-wrapper\r\n    expect(resolvedRelative).toEqual('success/npm-binary-wrapper.cmd');\r\n  } else {\r\n    expect(resolvedRelative).toEqual('success/npm-binary-wrapper');\r\n  }\r\n\r\n  // We should not find the \"missing-extension\" at all, because its file extension\r\n  // is not executable on Windows (and the execute bit is missing on Unix)\r\n  expect(Executable.tryResolve('missing-extension', options)).toBeUndefined();\r\n});\r\n\r\ntest('Executable.tryResolve() with path', () => {\r\n  const resolved: string | undefined = Executable.tryResolve('./npm-binary-wrapper', options);\r\n  expect(resolved).toBeUndefined();\r\n});\r\n\r\nfunction executeNpmBinaryWrapper(args: string[]): string[] {\r\n  const result: child_process.SpawnSyncReturns<string>\r\n    = Executable.spawnSync('npm-binary-wrapper', args, options);\r\n  expect(result.error).toBeUndefined();\r\n\r\n  expect(result.stderr).toBeDefined();\r\n  expect(result.stderr.toString()).toEqual('');\r\n\r\n  expect(result.stdout).toBeDefined();\r\n  const outputLines: string[] = result.stdout.toString().split(/[\\r\\n]+/g).map(x => x.trim());\r\n\r\n  let lineIndex: number = 0;\r\n  if (os.platform() === 'win32') {\r\n    expect(outputLines[lineIndex++]).toEqual('Executing npm-binary-wrapper.cmd with args:');\r\n  } else {\r\n    expect(outputLines[lineIndex++]).toEqual('Executing npm-binary-wrapper with args:');\r\n  }\r\n  // console.log('npm-binary-wrapper.cmd ARGS: ' + outputLines[lineIndex]);\r\n  ++lineIndex;  // skip npm-binary-wrapper's args\r\n\r\n  expect(outputLines[lineIndex++]).toEqual('Executing javascript-file.js with args:');\r\n\r\n  const stringifiedArgv: string = outputLines[lineIndex++];\r\n  expect(stringifiedArgv.substr(0, 2)).toEqual('[\\\"');\r\n\r\n  const argv: string[] = JSON.parse(stringifiedArgv);\r\n  // Discard the first two array entries whose path is nondeterministic\r\n  argv.shift();  // the path to node.exe\r\n  argv.shift();  // the path to javascript-file.js\r\n\r\n  return argv;\r\n}\r\n\r\ntest('Executable.spawnSync(\"npm-binary-wrapper\") simple', () => {\r\n  const args: string[] = ['arg1', 'arg2', 'arg3'];\r\n  expect(executeNpmBinaryWrapper(args)).toEqual(args);\r\n});\r\n\r\ntest('Executable.spawnSync(\"npm-binary-wrapper\") edge cases 1', () => {\r\n  // Characters that confuse the CreateProcess() WIN32 API's encoding\r\n  const args: string[] = ['', '/', ' \\t ', '\"a', 'b\"', '\"c\"', '\\\\\"\\\\d', '!', '!TEST_VAR!'];\r\n  expect(executeNpmBinaryWrapper(args)).toEqual(args);\r\n});\r\n\r\ntest('Executable.spawnSync(\"npm-binary-wrapper\") edge cases 2', () => {\r\n  // All ASCII punctuation\r\n  const args: string[] = [\r\n    // Characters that are impossible to escape for cmd.exe:\r\n    // %^&|<>  newline\r\n    '~!@#$*()_+`={}[]\\:\";\\'?,./',\r\n    '~!@#$*()_+`={}[]\\:\";\\'?,./'\r\n  ];\r\n  expect(executeNpmBinaryWrapper(args)).toEqual(args);\r\n});\r\n\r\ntest('Executable.spawnSync(\"npm-binary-wrapper\") edge cases 2', () => {\r\n  // All ASCII punctuation\r\n  const args: string[] = [\r\n    // Characters that are impossible to escape for cmd.exe:\r\n    // %^&|<>  newline\r\n    '~!@#$*()_+`={}[]\\:\";\\'?,./',\r\n    '~!@#$*()_+`={}[]\\:\";\\'?,./'\r\n  ];\r\n  expect(executeNpmBinaryWrapper(args)).toEqual(args);\r\n});\r\n\r\ntest('Executable.spawnSync(\"npm-binary-wrapper\") bad characters', () => {\r\n  if (os.platform() === 'win32') {\r\n    expect(() => { executeNpmBinaryWrapper(['abc%123']); })\r\n      .toThrowError('The command line argument \"abc%123\" contains a special character \"%\"'\r\n        + ' that cannot be escaped for the Windows shell');\r\n    expect(() => { executeNpmBinaryWrapper(['abc<>123']); })\r\n      .toThrowError('The command line argument \"abc<>123\" contains a special character \"<\"'\r\n        + ' that cannot be escaped for the Windows shell');\r\n  }\r\n});\r\n"],"sourceRoot":"../../../src"}