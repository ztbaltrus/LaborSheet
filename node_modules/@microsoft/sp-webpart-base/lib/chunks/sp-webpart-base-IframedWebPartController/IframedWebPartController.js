import iframedPropertyPaneStyles from './IframedPropertyPane.module.scss';
var WEBPART_IFRAME_ID_PREFIX = 'dom-isolated-webpart-';
var PROPERTYPANE_IFRAME_ID = 'dome-isolated-property-pane';
var IFRAMED_PROPERTYPANE_CONTAINER_ID = 'spIFramePropertyPaneContainer';
var IframedWebPartController = (function () {
    function IframedWebPartController() {
        this._iframeSrcUrl = undefined;
        this._iframedWebpartsMap = new Map();
        this._ppIframeElement = undefined;
    }
    IframedWebPartController.prototype.loadWebPart = function (absoluteUrlPrefix, listId, listItemId, instanceId, domElement) {
        this._iframeSrcUrl = absoluteUrlPrefix + "/_layouts/15/webpart.aspx?list=%7B";
        this._iframeSrcUrl += listId;
        this._iframeSrcUrl += '%7D&id=';
        this._iframeSrcUrl += listItemId;
        this._iframeSrcUrl += '&webPartInstanceId=';
        this._iframeSrcUrl += instanceId;
        this._iframedWebpartsMap.set(instanceId, this._iframeSrcUrl);
        this._registerToIframedPropertyPaneEvents();
        domElement.innerHTML = "<div>\n      <iframe\n        id=" + (WEBPART_IFRAME_ID_PREFIX + instanceId) + "\n        src=" + this._iframeSrcUrl + "\n        class=" + iframedPropertyPaneStyles.iframeWebPart + "\n      ></iframe>\n    </div>";
    };
    IframedWebPartController.prototype.requestPropertyPaneAction = function (instanceId, propertyPaneState) {
        this._iframeSrcUrl = this._iframedWebpartsMap.get(instanceId);
        switch (propertyPaneState) {
            case 1 :
                this._iframeSrcUrl += '&openPropertyPane=true';
                if (!this._ppIframeElement) {
                    if (!this._pageContentElement) {
                        this._pageContentElement = document.getElementById('spPageChromeAppDiv');
                    }
                    if (!this._iframedPropertyPaneContainer) {
                        this._iframedPropertyPaneContainer = document.createElement('div');
                        this._iframedPropertyPaneContainer.id = IFRAMED_PROPERTYPANE_CONTAINER_ID;
                        this._iframedPropertyPaneContainer.className = iframedPropertyPaneStyles.spIFramePropertyPaneContainer;
                        this._iframedPropertyPaneContainer.classList.add(iframedPropertyPaneStyles.showPane);
                    }
                    this._iframedPropertyPaneContainer.innerHTML = "\n            <iframe\n              id=" + PROPERTYPANE_IFRAME_ID + "\n              src=" + this._iframeSrcUrl + "\n              class=" + iframedPropertyPaneStyles.iframePropertyPane + "\n            ></iframe>";
                    var parent_1 = this._pageContentElement.parentElement;
                    parent_1.appendChild(this._iframedPropertyPaneContainer);
                    this._ppIframeElement = document.getElementById(PROPERTYPANE_IFRAME_ID);
                    this._ppIframeElement.src = this._iframeSrcUrl;
                }
                this._showPropertyPane(instanceId);
                break;
            case 2 :
                this._hidePropertyPane(instanceId);
                break;
            case 3 :
                if (!this._iframedPropertyPaneContainer.classList.contains(iframedPropertyPaneStyles.showPane)) {
                    this._showPropertyPane(instanceId);
                }
                else {
                    this._hidePropertyPane(instanceId);
                }
                break;
            case 4 :
                break;
        }
    };
    IframedWebPartController.prototype._hidePropertyPane = function (webPartInstanceId) {
        if (this._iframedPropertyPaneContainer) {
            var eventData = {
                webPartInstanceId: webPartInstanceId,
                action: 2 
            };
            this._ppIframeElement.contentWindow.postMessage(eventData, window.location.origin);
            this._iframedPropertyPaneContainer.classList.remove(iframedPropertyPaneStyles.showPane);
            this._iframedPropertyPaneContainer.classList.add(iframedPropertyPaneStyles.hidePane);
            this._pageContentElement.classList.remove(iframedPropertyPaneStyles.shrinkContent);
        }
    };
    IframedWebPartController.prototype._showPropertyPane = function (webPartInstanceId) {
        var eventData = {
            webPartInstanceId: webPartInstanceId,
            action: 1 
        };
        this._ppIframeElement.contentWindow.postMessage(eventData, window.location.origin);
        this._iframedPropertyPaneContainer.classList.add(iframedPropertyPaneStyles.showPane);
        this._iframedPropertyPaneContainer.classList.remove(iframedPropertyPaneStyles.hidePane);
        this._pageContentElement.classList.add(iframedPropertyPaneStyles.shrinkContent);
    };
    IframedWebPartController.prototype._receivePropertyPaneEvent = function (event) {
        if (event.origin === window.location.origin) {
            if (event.data && event.data.propertyPaneEvent
                && event.data.propertyPaneEvent === 4 
                && this._iframedWebpartsMap.get(event.data.instanceId)) {
                this._hidePropertyPane(event.data.instanceId);
            }
        }
    };
    IframedWebPartController.prototype._registerToIframedPropertyPaneEvents = function () {
        this._receivePropertyPaneEvent = this._receivePropertyPaneEvent.bind(this);
        window.addEventListener('message', this._receivePropertyPaneEvent);
    };
    return IframedWebPartController;
}());
export default IframedWebPartController;
