{"version":3,"sources":["ExtractorContext.ts"],"names":[],"mappings":";AAAA,4FAA4F;AAC5F,2DAA2D;;AAG3D,6BAA6B;AAC7B,oEAMsC;AAEtC,iDAA8C;AAC9C,mDAAgD;AAgChD;;;;GAIG;AACH;IA6BE,YAAY,OAAiC;QAC3C,IAAI,CAAC,iBAAiB,GAAG,IAAI,qCAAiB,EAAE,CAAC;QAEjD,IAAI,CAAC,QAAQ,GAAG,OAAO,CAAC,QAAQ,CAAC;QACjC,IAAI,CAAC,eAAe,GAAG,OAAO,CAAC,eAAe,CAAC;QAE/C,MAAM,MAAM,GAAuB,IAAI,CAAC,iBAAiB,CAAC,sBAAsB,CAAC,OAAO,CAAC,cAAc,CAAC,CAAC;QACzG,EAAE,CAAC,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC;YACZ,MAAM,IAAI,KAAK,CAAC,iDAAiD,GAAG,OAAO,CAAC,cAAc,CAAC,CAAC;QAC9F,CAAC;QACD,IAAI,CAAC,cAAc,GAAG,MAAM,CAAC;QAE7B,IAAI,CAAC,WAAW,GAAG,IAAI,CAAC,iBAAiB,CAAC,qBAAqB,CAAC,IAAI,CAAC,cAAc,CAAE,CAAC;QAEtF,IAAI,CAAC,iBAAiB,GAAG,+BAAW,CAAC,KAAK,CAAC,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC;QAElE,IAAI,CAAC,aAAa,GAAG,IAAI,6BAAa,CAAC,IAAI,CAAC,cAAc,CAAC,CAAC;QAE5D,IAAI,CAAC,OAAO,GAAG,OAAO,CAAC,MAAM,CAAC;QAE9B,iGAAiG;QACjG,4FAA4F;QAC5F,4DAA4D;QAC5D,GAAG,CAAC,CAAC,MAAM,UAAU,IAAI,OAAO,CAAC,OAAO,CAAC,sBAAsB,EAAE,CAAC,CAAC,CAAC;YAClE,IAAI,CAAC,WAAW,CAAC,cAAc,GAAG,UAAU,CAAC,WAAW,EAAE,UAAU,CAAC,IAAI,EAAE,UAAU,CAAC,KAAK,CAAC,CAAC;QAC/F,CAAC;QAED,IAAI,CAAC,WAAW,GAAG,OAAO,CAAC,OAAO,CAAC,cAAc,EAAE,CAAC;QAEpD,MAAM,QAAQ,GAAkB,OAAO,CAAC,OAAO,CAAC,aAAa,CAAC,OAAO,CAAC,cAAc,CAAC,CAAC;QACtF,EAAE,CAAC,CAAC,CAAC,QAAQ,CAAC,CAAC,CAAC;YACd,MAAM,IAAI,KAAK,CAAC,uBAAuB,GAAG,OAAO,CAAC,cAAc,CAAC,CAAC;QACpE,CAAC;QAED,IAAI,CAAC,OAAO,GAAG,IAAI,uBAAU,CAAC,IAAI,EAAE,QAAQ,CAAC,CAAC,CAAC,oBAAoB;QACnE,IAAI,CAAC,OAAO,CAAC,sBAAsB,EAAE,CAAC,CAAC,2BAA2B;QAClE,IAAI,CAAC,OAAO,CAAC,6BAA6B,EAAE,CAAC;IAC/C,CAAC;IAED;;OAEG;IACH,IAAW,WAAW;QACpB,MAAM,CAAC,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC;IAC/B,CAAC;IAED;;OAEG;IACH,IAAW,aAAa;QACtB,MAAM,CAAC,IAAI,CAAC,cAAc,CAAC;IAC7B,CAAC;IAED;;OAEG;IACI,WAAW,CAAC,OAAe,EAAE,UAAqC,EAAE,KAAyB;QAClG,EAAE,CAAC,CAAC,UAAU,IAAI,KAAK,CAAC,CAAC,CAAC;YACxB,MAAM,gBAAgB,GAAwB,UAAU,CAAC,6BAA6B,CAAC,KAAK,CAAC,CAAC;YAE9F,oEAAoE;YACpE,MAAM,YAAY,GAAW,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,aAAa,EAAE,UAAU,CAAC,QAAQ,CAAC,CAAC;YACpF,MAAM,SAAS,GAAW,YAAY,CAAC,MAAM,CAAC,CAAC,EAAE,CAAC,CAAC,KAAK,IAAI,GAAG,UAAU,CAAC,QAAQ,GAAG,YAAY,CAAC;YAElG,gEAAgE;YAChE,0EAA0E;YAC1E,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,GAAG,SAAS,IAAI,gBAAgB,CAAC,IAAI,GAAG,CAAC,IAAI,gBAAgB,CAAC,SAAS,GAAG,CAAC,KAAK;kBAClG,OAAO,CAAC,CAAC;QACf,CAAC;QAAC,IAAI,CAAC,CAAC;YACN,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAC;QACjC,CAAC;IACH,CAAC;IAED;;;;;;;;OAQG;IACI,oBAAoB,CAAC,0BAAkC;QAC5D,EAAE,CAAC,CAAC,CAAC,0BAA0B,CAAC,CAAC,CAAC;YAChC,MAAM,CAAC;QACT,CAAC;QAED,8BAAU,CAAC,UAAU,CAAC,0BAA0B,EAAE;YAChD,aAAa,EAAE,IAAI;SACpB,CAAC,CAAC,OAAO,CAAC,IAAI;YACb,EAAE,CAAC,CAAC,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,KAAK,OAAO,CAAC,CAAC,CAAC;gBACnC,yDAAyD;gBACzD,MAAM,WAAW,GAAW,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC,IAAI,CAAC;gBAClD,IAAI,CAAC,aAAa,CAAC,oBAAoB,CAAC,IAAI,EAAE,WAAW,CAAC,CAAC;YAC7D,CAAC;QACH,CAAC,CAAC,CAAC;IACL,CAAC;CACF;AA9HD,4CA8HC","file":"ExtractorContext.js","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\nimport * as ts from 'typescript';\r\nimport * as path from 'path';\r\nimport {\r\n  PackageJsonLookup,\r\n  IPackageJson,\r\n  PackageName,\r\n  IParsedPackageName,\r\n  FileSystem\r\n} from '@microsoft/node-core-library';\r\n\r\nimport { AstPackage } from './ast/AstPackage';\r\nimport { DocItemLoader } from './DocItemLoader';\r\nimport { ILogger } from './extractor/ILogger';\r\nimport { IExtractorPoliciesConfig, IExtractorValidationRulesConfig } from './extractor/IExtractorConfig';\r\n\r\n/**\r\n * Options for ExtractorContext constructor.\r\n */\r\nexport interface IExtractorContextOptions {\r\n  /**\r\n   * Configuration for the TypeScript compiler.  The most important options to set are:\r\n   *\r\n   * - target: ts.ScriptTarget.ES5\r\n   * - module: ts.ModuleKind.CommonJS\r\n   * - moduleResolution: ts.ModuleResolutionKind.NodeJs\r\n   * - rootDir: inputFolder\r\n   */\r\n  program: ts.Program;\r\n\r\n  /**\r\n   * The entry point for the project.  This should correspond to the \"main\" field\r\n   * from NPM's package.json file.  If it is a relative path, it will be relative to\r\n   * the project folder described by IExtractorAnalyzeOptions.compilerOptions.\r\n   */\r\n  entryPointFile: string;\r\n\r\n  logger: ILogger;\r\n\r\n  policies: IExtractorPoliciesConfig;\r\n\r\n  validationRules: IExtractorValidationRulesConfig;\r\n}\r\n\r\n/**\r\n * The main entry point for the \"api-extractor\" utility.  The Analyzer object invokes the\r\n * TypeScript Compiler API to analyze a project, and constructs the AstItem\r\n * abstract syntax tree.\r\n */\r\nexport class ExtractorContext {\r\n  public typeChecker: ts.TypeChecker;\r\n  public package: AstPackage;\r\n\r\n  /**\r\n   * The parsed package.json file for this package.\r\n   */\r\n  public readonly packageJson: IPackageJson;\r\n\r\n  public readonly parsedPackageName: IParsedPackageName;\r\n\r\n  /**\r\n   * One DocItemLoader is needed per analyzer to look up external API members\r\n   * as needed.\r\n   */\r\n  public readonly docItemLoader: DocItemLoader;\r\n\r\n  public readonly packageJsonLookup: PackageJsonLookup;\r\n\r\n  public readonly policies: IExtractorPoliciesConfig;\r\n\r\n  public readonly validationRules: IExtractorValidationRulesConfig;\r\n\r\n  // If the entry point is \"C:\\Folder\\project\\src\\index.ts\" and the nearest package.json\r\n  // is \"C:\\Folder\\project\\package.json\", then the packageFolder is \"C:\\Folder\\project\"\r\n  private _packageFolder: string;\r\n\r\n  private _logger: ILogger;\r\n\r\n  constructor(options: IExtractorContextOptions) {\r\n    this.packageJsonLookup = new PackageJsonLookup();\r\n\r\n    this.policies = options.policies;\r\n    this.validationRules = options.validationRules;\r\n\r\n    const folder: string | undefined = this.packageJsonLookup.tryGetPackageFolderFor(options.entryPointFile);\r\n    if (!folder) {\r\n      throw new Error('Unable to find a package.json for entry point: ' + options.entryPointFile);\r\n    }\r\n    this._packageFolder = folder;\r\n\r\n    this.packageJson = this.packageJsonLookup.tryLoadPackageJsonFor(this._packageFolder)!;\r\n\r\n    this.parsedPackageName = PackageName.parse(this.packageJson.name);\r\n\r\n    this.docItemLoader = new DocItemLoader(this._packageFolder);\r\n\r\n    this._logger = options.logger;\r\n\r\n    // This runs a full type analysis, and then augments the Abstract Syntax Tree (i.e. declarations)\r\n    // with semantic information (i.e. symbols).  The \"diagnostics\" are a subset of the everyday\r\n    // compile errors that would result from a full compilation.\r\n    for (const diagnostic of options.program.getSemanticDiagnostics()) {\r\n      this.reportError('TypeScript: ' + diagnostic.messageText, diagnostic.file, diagnostic.start);\r\n    }\r\n\r\n    this.typeChecker = options.program.getTypeChecker();\r\n\r\n    const rootFile: ts.SourceFile = options.program.getSourceFile(options.entryPointFile);\r\n    if (!rootFile) {\r\n      throw new Error('Unable to load file: ' + options.entryPointFile);\r\n    }\r\n\r\n    this.package = new AstPackage(this, rootFile); // construct members\r\n    this.package.completeInitialization(); // creates ApiDocumentation\r\n    this.package.visitTypeReferencesForAstItem();\r\n  }\r\n\r\n  /**\r\n   * Returns the full name of the package being analyzed.\r\n   */\r\n  public get packageName(): string {\r\n    return this.packageJson.name;\r\n  }\r\n\r\n  /**\r\n   * Returns the folder for the package being analyzed.\r\n   */\r\n  public get packageFolder(): string {\r\n    return this._packageFolder;\r\n  }\r\n\r\n  /**\r\n   * Reports an error message to the registered ApiErrorHandler.\r\n   */\r\n  public reportError(message: string, sourceFile: ts.SourceFile | undefined, start: number | undefined): void {\r\n    if (sourceFile && start) {\r\n      const lineAndCharacter: ts.LineAndCharacter = sourceFile.getLineAndCharacterOfPosition(start);\r\n\r\n      // If the file is under the packageFolder, then show a relative path\r\n      const relativePath: string = path.relative(this.packageFolder, sourceFile.fileName);\r\n      const shownPath: string = relativePath.substr(0, 2) === '..' ? sourceFile.fileName : relativePath;\r\n\r\n      // Format the error so that VS Code can follow it.  For example:\r\n      // \"src\\MyClass.ts(15,1): The JSDoc tag \"@blah\" is not supported by AEDoc\"\r\n      this._logger.logError(`${shownPath}(${lineAndCharacter.line + 1},${lineAndCharacter.character + 1}): `\r\n        + message);\r\n    } else {\r\n      this._logger.logError(message);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Scans for external package api files and loads them into the docItemLoader member before\r\n   * any API analysis begins.\r\n   *\r\n   * @param externalJsonCollectionPath - an absolute path to to the folder that contains all the external\r\n   * api json files.\r\n   * Ex: if externalJsonPath is './resources', then in that folder\r\n   * are 'es6-collections.api.json', etc.\r\n   */\r\n  public loadExternalPackages(externalJsonCollectionPath: string): void {\r\n    if (!externalJsonCollectionPath) {\r\n      return;\r\n    }\r\n\r\n    FileSystem.readFolder(externalJsonCollectionPath, {\r\n      absolutePaths: true\r\n    }).forEach(file => {\r\n      if (path.extname(file) === '.json') {\r\n        // Example: \"C:\\Example\\my-package.json\" --> \"my-package\"\r\n        const packageName: string = path.parse(file).name;\r\n        this.docItemLoader.loadPackageIntoCache(file, packageName);\r\n      }\r\n    });\r\n  }\r\n}\r\n"],"sourceRoot":"../src"}