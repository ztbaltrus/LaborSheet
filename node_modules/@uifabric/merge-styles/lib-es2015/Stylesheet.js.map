{"version":3,"file":"Stylesheet.js","sourceRoot":"../src/","sources":["Stylesheet.ts"],"names":[],"mappings":"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","sourcesContent":["import { IStyle } from './IStyle';\r\n/**\r\n * Injection mode for the stylesheet.\r\n *\r\n * @public\r\n */\r\nexport const enum InjectionMode {\r\n  /**\r\n   * Avoids style injection, use getRules() to read the styles.\r\n   */\r\n  none = 0,\r\n\r\n  /**\r\n   * Inserts rules using the insertRule api.\r\n   */\r\n  insertNode = 1,\r\n\r\n  /**\r\n   * Appends rules using appendChild.\r\n   */\r\n  appendChild = 2\r\n}\r\n\r\n/**\r\n * Stylesheet config.\r\n *\r\n * @public\r\n */\r\nexport interface IStyleSheetConfig {\r\n  /**\r\n   * Injection mode for how rules are inserted.\r\n   */\r\n  injectionMode?: InjectionMode;\r\n  /**\r\n   * Falls back to \"css\".\r\n   */\r\n  defaultPrefix?: string;\r\n  onInsertRule?: (rule: string) => void;\r\n}\r\n\r\nconst STYLESHEET_SETTING = '__stylesheet__';\r\n\r\nlet _stylesheet: Stylesheet;\r\n\r\n/**\r\n * Represents the state of styles registered in the page. Abstracts\r\n * the surface for adding styles to the stylesheet, exposes helpers\r\n * for reading the styles registered in server rendered scenarios.\r\n *\r\n * @public\r\n */\r\nexport class Stylesheet {\r\n  private _lastStyleElement?: HTMLStyleElement;\r\n  private _styleElement?: HTMLStyleElement;\r\n  private _rules: string[] = [];\r\n  private _config: IStyleSheetConfig;\r\n  private _rulesToInsert: string[] = [];\r\n  private _counter = 0;\r\n  private _keyToClassName: { [key: string]: string } = {};\r\n\r\n  // tslint:disable-next-line:no-any\r\n  private _classNameToArgs: { [key: string]: { args: any, rules: string[] } } = {};\r\n\r\n  /**\r\n   * Gets the singleton instance.\r\n   */\r\n  public static getInstance(): Stylesheet {\r\n    // tslint:disable-next-line:no-any\r\n    const win: any = typeof window !== 'undefined' ? window : {};\r\n    _stylesheet = win[STYLESHEET_SETTING] as Stylesheet;\r\n\r\n    if (!_stylesheet) {\r\n      // tslint:disable-next-line:no-string-literal\r\n      const fabricConfig = (win && win['FabricConfig']) || {};\r\n\r\n      _stylesheet = win[STYLESHEET_SETTING] = new Stylesheet(fabricConfig.mergeStyles);\r\n    }\r\n\r\n    return _stylesheet;\r\n  }\r\n\r\n  constructor(config?: IStyleSheetConfig) {\r\n    this._config = {\r\n      injectionMode: InjectionMode.insertNode,\r\n      defaultPrefix: 'css',\r\n      ...config\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Configures the stylesheet.\r\n   */\r\n  public setConfig(config?: IStyleSheetConfig): void {\r\n    this._config = {\r\n      ...this._config,\r\n      ...config\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Generates a unique classname.\r\n   *\r\n   * @param displayName - Optional value to use as a prefix.\r\n   */\r\n  public getClassName(displayName?: string): string {\r\n    const prefix = displayName || this._config.defaultPrefix;\r\n\r\n    return `${prefix}-${this._counter++}`;\r\n  }\r\n\r\n  /**\r\n   * Used internally to cache information about a class which was\r\n   * registered with the stylesheet.\r\n   */\r\n  public cacheClassName(\r\n    className: string,\r\n    key: string,\r\n    args: IStyle[],\r\n    rules: string[]\r\n  ): void {\r\n    this._keyToClassName[key] = className;\r\n    this._classNameToArgs[className] = {\r\n      args,\r\n      rules\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Gets the appropriate classname given a key which was previously\r\n   * registered using cacheClassName.\r\n   */\r\n  public classNameFromKey(key: string): string | undefined {\r\n    return this._keyToClassName[key];\r\n  }\r\n\r\n  /**\r\n   * Gets the arguments associated with a given classname which was\r\n   * previously registered using cacheClassName.\r\n   */\r\n  public argsFromClassName(className: string): IStyle[] | undefined {\r\n    const entry = this._classNameToArgs[className];\r\n\r\n    return (entry && entry.args);\r\n  }\r\n\r\n  /**\r\n * Gets the arguments associated with a given classname which was\r\n * previously registered using cacheClassName.\r\n */\r\n  public insertedRulesFromClassName(className: string): string[] | undefined {\r\n    const entry = this._classNameToArgs[className];\r\n\r\n    return (entry && entry.rules);\r\n  }\r\n\r\n  /**\r\n   * Inserts a css rule into the stylesheet.\r\n   */\r\n  public insertRule(\r\n    rule: string\r\n  ): void {\r\n    const { injectionMode } = this._config;\r\n    const element = injectionMode !== InjectionMode.none ? this._getStyleElement() : undefined;\r\n\r\n    if (element) {\r\n      switch (this._config.injectionMode) {\r\n        case InjectionMode.insertNode:\r\n          const { sheet } = element!;\r\n\r\n          try {\r\n            (sheet as CSSStyleSheet).insertRule(rule, (sheet as CSSStyleSheet).cssRules.length);\r\n          } catch (e) {\r\n            // The browser will throw exceptions on unsupported rules (such as a moz prefix in webkit.)\r\n            // We need to swallow the exceptions for this scenario, otherwise we'd need to filter\r\n            // which could be slower and bulkier.\r\n          }\r\n          break;\r\n\r\n        case InjectionMode.appendChild:\r\n          element.appendChild(document.createTextNode(rule));\r\n          break;\r\n      }\r\n    } else {\r\n      this._rules.push(rule);\r\n    }\r\n\r\n    if (this._config.onInsertRule) {\r\n      this._config.onInsertRule(rule);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Gets all rules registered with the stylesheet; only valid when\r\n   * using InsertionMode.none.\r\n   */\r\n  public getRules(): string {\r\n    return (this._rules.join('') || '') + (this._rulesToInsert.join('') || '');\r\n  }\r\n\r\n  /**\r\n   * Resets the internal state of the stylesheet. Only used in server\r\n   * rendered scenarios where we're using InsertionMode.none.\r\n   */\r\n  public reset(): void {\r\n    this._rules = [];\r\n    this._rulesToInsert = [];\r\n    this._counter = 0;\r\n    this._classNameToArgs = {};\r\n    this._keyToClassName = {};\r\n  }\r\n\r\n  // Forces the regeneration of incoming styles without totally resetting the stylesheet.\r\n  public resetKeys(): void {\r\n    this._keyToClassName = {};\r\n  }\r\n\r\n  private _getStyleElement(): HTMLStyleElement | undefined {\r\n    if (!this._styleElement && typeof document !== 'undefined') {\r\n      this._styleElement = this._createStyleElement();\r\n\r\n      // Reset the style element on the next frame.\r\n      window.requestAnimationFrame(() => {\r\n        this._styleElement = undefined;\r\n      });\r\n    }\r\n    return this._styleElement;\r\n  }\r\n\r\n  private _createStyleElement(): HTMLStyleElement {\r\n    const styleElement = document.createElement('style');\r\n\r\n    styleElement.setAttribute('data-merge-styles', 'true');\r\n    styleElement.type = 'text/css';\r\n\r\n    if (this._lastStyleElement && this._lastStyleElement.nextElementSibling) {\r\n      document.head.insertBefore(styleElement, this._lastStyleElement.nextElementSibling);\r\n    } else {\r\n      document.head.appendChild(styleElement);\r\n    }\r\n    this._lastStyleElement = styleElement;\r\n\r\n    return styleElement;\r\n  }\r\n\r\n}"]}